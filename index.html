<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Feedback</title>
    <style>
        /* Basic Reset & Body Styling */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px; /* Base font size */
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f4;
            color: #333;
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align items to the top */
            min-height: 100vh;
            padding: 20px;
            /* Prevent background scroll when modal/overlay might be active */
            /* overflow: hidden; */ /* Reconsider if needed */
        }

        /* Main Container */
        .container {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px; /* Max width for larger screens */
            text-align: center;
        }

        /* Header */
        header h1 {
            color: #4a90e2; /* A nice blue */
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        /* Screen Management */
        .screen {
            display: none; /* Hide screens by default */
        }
        .screen.active {
            display: block; /* Show active screen */
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Feedback Section Specifics */
        #feedback-section h2 {
            margin-bottom: 15px;
            color: #555;
            font-size: 1.3rem;
        }
        #feedback-section p {
            margin-bottom: 20px;
            color: #666;
            font-size: 1rem;
        }

        /* Group Selection Buttons */
        .group-selection {
            margin-bottom: 30px;
            display: flex; /* Use flexbox for layout */
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
            justify-content: center; /* Center buttons */
            gap: 15px; /* Spacing between buttons */
        }

        .group-button {
            padding: 12px 20px;
            font-size: 1rem;
            background-color: #e7e7e7; /* Light grey background */
            color: #333;
            border: 2px solid #dcdcdc; /* Subtle border */
            border-radius: 25px; /* Rounded corners */
            cursor: pointer;
            transition: all 0.3s ease;
            flex-grow: 1; /* Allow buttons to grow */
            min-width: 120px; /* Minimum width */
            text-align: center;
        }

        .group-button:hover {
            background-color: #dcdcdc; /* Darken on hover */
            border-color: #c0c0c0;
        }

        .group-button.selected {
            background-color: #4a90e2; /* Blue when selected */
            color: #fff;
            border-color: #357abd; /* Darker blue border */
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Feedback Options Section (Ratings + Comment) - Initially Hidden */
        .feedback-details {
            border-top: 1px solid #eee;
            padding-top: 25px;
            margin-top: 25px;
            display: none; /* Hide by default */
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }


        /* Show feedback details when a group is selected */
        #feedback-section.group-selected .feedback-details {
            display: block;
            opacity: 1;
        }


        .feedback-options {
            display: flex;
            justify-content: center;
            gap: 20px; /* Space between rating buttons */
            margin-bottom: 25px;
        }

        .feedback-button {
            width: 60px; /* Width of the button */
            height: 60px; /* Height of the button */
            font-size: 2rem; /* Size of the emoji/icon */
            line-height: 60px; /* Vertically center emoji */
            text-align: center;
            border: none;
            border-radius: 50%; /* Make it circular */
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            background-color: #f0f0f0; /* Default background */
            color: #333; /* Default text/emoji color */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .feedback-button:hover {
            transform: scale(1.1); /* Slightly enlarge on hover */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        /* Specific Rating Button Styles */
        .feedback-button[data-rating="1"] { background-color: #a5d6a7; /* Light Green */ } /* Happy */
        .feedback-button[data-rating="2"] { background-color: #ffe082; /* Light Yellow */ } /* Neutral */
        .feedback-button[data-rating="3"] { background-color: #ef9a9a; /* Light Red */ } /* Sad */

        .feedback-button[data-rating="1"]:hover { background-color: #81c784; } /* Darker Green */
        .feedback-button[data-rating="2"]:hover { background-color: #ffd54f; } /* Darker Yellow */
        .feedback-button[data-rating="3"]:hover { background-color: #e57373; } /* Darker Red */

        /* Comment Section */
        .comment-section {
            margin-top: 20px;
            text-align: left; /* Align label left */
        }

        .comment-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .textarea-wrapper {
            position: relative; /* Needed for absolute positioning of the mic button */
            display: flex;
            align-items: flex-start; /* Align items top */
        }

        .comment-section textarea {
            width: 100%; /* Take full width */
            padding: 10px 45px 10px 10px; /* Right padding for mic button */
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
            line-height: 1.5;
            resize: vertical; /* Allow vertical resize */
            min-height: 80px;
            flex-grow: 1; /* Allow textarea to grow */
        }

        .mic-button {
            position: absolute;
            right: 5px;
            top: 5px; /* Adjust vertical position */
            width: 35px;
            height: 35px;
            border: none;
            background-color: transparent;
            border-radius: 50%;
            cursor: pointer;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            color: #666;
            transition: background-color 0.2s, color 0.2s;
        }
        .mic-button:hover {
            background-color: #eee;
        }
        .mic-button:disabled {
            color: #bbb;
            cursor: not-allowed;
            background-color: transparent;
        }
        .mic-button.is-recording .mic-icon.default {
            display: none;
        }
        .mic-button.is-recording .mic-icon.recording {
            display: inline;
            color: red;
        }
        .mic-button .mic-icon.recording {
            display: none; /* Hide stop icon by default */
        }


        .comment-error-message {
            color: #d9534f; /* Red for errors */
            font-size: 0.9em;
            margin-top: 5px;
            min-height: 1.2em; /* Reserve space */
            text-align: left;
        }

        /* Style for the new clear button */
        .clear-button {
          display: block; /* Take its own line */
          margin-top: 8px; /* Space above the button */
          margin-left: 0; /* Align left */
          padding: 8px 12px;
          background-color: #e0e0e0; /* A neutral grey */
          color: #333;
          border: 1px solid #ccc;
          border-radius: 4px;
          cursor: pointer;
          font-size: 0.9em;
          transition: background-color 0.2s ease;
        }

        .clear-button:hover {
          background-color: #d1d1d1;
        }

        .clear-button:disabled {
            background-color: #f0f0f0;
            color: #aaa;
            cursor: not-allowed;
            border-color: #e0e0e0;
        }

        /* Utility class to hide elements */
        .hidden {
          display: none !important; /* Use important to override potential block display */
        }


        /* Loading Indicator */
        #loading-indicator {
            margin-top: 20px;
            font-size: 1rem;
            color: #4a90e2;
        }

        /* Thank You Screen */
        #thank-you h2 {
            color: #5cb85c; /* Green for success */
            font-size: 1.8rem;
            margin-bottom: 15px;
        }
        #thank-you p {
            font-size: 1.1rem;
            color: #555;
        }

        /* Button disabled state */
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Responsive Adjustments */
        @media (max-width: 640px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
            }
            header h1 {
                font-size: 1.6rem;
            }
            #feedback-section h2 {
                font-size: 1.2rem;
            }
            #feedback-section p {
                font-size: 0.95rem;
            }
            .group-selection {
                gap: 10px;
            }
            .group-button {
                padding: 10px 15px;
                font-size: 0.9rem;
                min-width: 100px;
            }
            .feedback-options {
                gap: 15px;
            }
            .feedback-button {
                width: 50px;
                height: 50px;
                font-size: 1.8rem;
                line-height: 50px;
            }
            .comment-section textarea {
                font-size: 0.95rem;
                padding: 8px 40px 8px 8px; /* Adjust padding for smaller mic button */
            }
             .mic-button {
                right: 3px;
                top: 3px;
                width: 30px;
                height: 30px;
                font-size: 1.3rem;
            }
             .clear-button {
                padding: 6px 10px;
                font-size: 0.85em;
             }
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Mensa Feedback</h1>
        </header>

        <main id="feedback-main-content">
            <!-- Feedback Screen -->
            <section id="feedback-section" class="screen active">
                <h2>Wie war dein Essen heute?</h2>
                <p>Wähle zuerst deine Klasse/Gruppe:</p>

                <div class="group-selection">
                    <button type="button" class="group-button" data-group="1-4 Klasse">1-4 Klasse</button>
                    <button type="button" class="group-button" data-group="5-8 Klasse">5-8 Klasse</button>
                    <button type="button" class="group-button" data-group="9-12 Klasse">9-12 Klasse</button>
                    <button type="button" class="group-button" data-group="Personal">Personal</button>
                    <button type="button" class="group-button" data-group="Gast">Gast</button>
                </div>

                <!-- Details appear after group selection -->
                <div class="feedback-details">
                    <p>Bewerte das Essen:</p>
                    <div class="feedback-options">
                        <button type="button" class="feedback-button" data-rating="1" title="Sehr gut">😋</button>
                        <button type="button" class="feedback-button" data-rating="2" title="Okay">😐</button>
                        <button type="button" class="feedback-button" data-rating="3" title="Nicht gut">🤢</button>
                    </div>

                    <!-- Comment Section -->
                    <div class="comment-section">
                      <label for="comment">Kommentar hinzufügen:</label>
                      <div class="textarea-wrapper">
                        <textarea id="comment" name="kommentar" placeholder="Optional: Füge einen Kommentar hinzu oder diktiere ihn..." rows="4"></textarea>
                        <button type="button" id="record-comment-button" class="mic-button" title="Kommentar diktieren">
                          <span class="mic-icon default">🎤</span>
                          <span class="mic-icon recording" style="display: none;">🛑</span>
                        </button>
                      </div> <!-- Closing div for textarea-wrapper -->

                      <div id="comment-error" class="comment-error-message"></div>

                      <!-- Add this button -->
                      <button type="button" id="clear-comment-button" class="clear-button hidden">
                         Kommentar löschen
                      </button>
                      <!-- End of added button -->

                    </div> <!-- Closing comment-section -->

                    <!-- Loading Indicator -->
                    <div id="loading-indicator" style="display: none;">
                        <p>Sende Feedback...</p>
                    </div>
                </div> <!-- Closing feedback-details -->

            </section>

            <!-- Thank You Screen -->
            <section id="thank-you" class="screen">
                <h2>Danke! 🙏</h2>
                <p>Dein Feedback wurde erfolgreich übermittelt.</p>
            </section>
        </main>
    </div>

    <script>
        // --- START OF updated script.js content ---
        // --- VERY BASIC CHECK ---
        console.log("--- script.js started loading ---");

        // Wrap entire code in a try...catch to catch early syntax errors
        try {
            document.addEventListener('DOMContentLoaded', () => {
                console.log("--- DOMContentLoaded event fired ---");

                // Wrap handler content in try...catch for initialization errors
                try {
                    // --- CONFIGURATION ---
                    const googleAppsScriptUrl = 'https://script.google.com/macros/s/AKfycbw_PX8InYEZm1tc6uVLYYZpBSTYjVB4fXXHCj62nLsZr7n6N2nspr3wXLjoP68GgIdIsw/exec';
                    const thankYouDuration = 1200;
                    const commentRequiredLength = 15;
                    // ---------------------

                    // --- AUDIO CONFIGURATION ---
                    const sounds = {
                        '1-4 Klasse': new Audio('1-4_klasse.wav'), '5-8 Klasse': new Audio('5-8_klasse.mp3'),
                        '9-12 Klasse': new Audio('9-12_klasse.wav'), 'rating-1': new Audio('green.mp3'),
                        'rating-2': new Audio('yellow.mp3'), 'rating-3-success': new Audio('red.mp3'),
                        'sent': new Audio('sent.wav'), 'error': new Audio('error.wav')
                    };
                    Object.entries(sounds).forEach(([key, audio]) => { audio.onerror = (e) => console.error(`Audio Load Error '${key}':`, e); });
                    // ---------------------

                    console.log("Config & Sounds Initialized.");

                    // --- ELEMENT SELECTION (with early exit on failure) ---
                    console.log("Selecting DOM elements...");
                    const feedbackScreen = document.getElementById('feedback-section');
                    const thankYouScreen = document.getElementById('thank-you');
                    const allGroupButtons = document.querySelectorAll('#feedback-section .group-button'); // Combined selector
                    const feedbackRatingButtons = document.querySelectorAll('#feedback-section .feedback-options .feedback-button');
                    const loadingIndicator = document.getElementById('loading-indicator');
                    const commentInput = document.getElementById('comment');
                    const commentError = document.getElementById('comment-error');
                    const recordButton = document.getElementById('record-comment-button'); // Microphone button
                    const clearCommentButton = document.getElementById('clear-comment-button'); // <<< NEW: Clear button

                    // Strict check for essential elements
                    if (!feedbackScreen || !thankYouScreen || !loadingIndicator || !commentInput || !commentError || !recordButton || !clearCommentButton) { // <<< Added check for clear button
                        console.error("CRITICAL STOP: Essential UI element missing!");
                        let missingElement = !feedbackScreen ? "feedback screen" : !thankYouScreen ? "thank you screen" : !loadingIndicator ? "loading indicator" : !commentInput ? "comment input" : !commentError ? "comment error" : !recordButton ? "record button" : "clear comment button";
                        if (commentError) commentError.textContent = `App-Fehler: UI-Element (${missingElement}) nicht gefunden.`;
                        else alert(`App-Fehler: UI-Element (${missingElement}) nicht gefunden.`);
                        return;
                    }
                    if (allGroupButtons.length === 0) { console.error("CRITICAL STOP: 0 group buttons found!"); if(commentError) commentError.textContent = "App-Fehler: Gruppen-Buttons fehlen."; return; }
                    if (feedbackRatingButtons.length === 0) { console.error("CRITICAL STOP: 0 rating buttons found!"); if(commentError) commentError.textContent = "App-Fehler: Bewertungs-Buttons fehlen."; return; }
                    console.log(`Elements found: ${allGroupButtons.length} groups, ${feedbackRatingButtons.length} ratings.`);
                    console.log("Essential elements selection successful.");

                    // --- App State ---
                    let selectedGroup = null, selectedRating = null, isSubmitting = false, lastPlayedRatingSound = null;
                    let isMicRecording = false; // State for Web Speech API active
                    let recognition;
                    let speechApiSupported = false;

                    // --- Web Speech API Setup ---
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

                    if (SpeechRecognition) {
                        console.log("Web Speech API is supported!");
                        speechApiSupported = true;
                        recognition = new SpeechRecognition();
                        recognition.continuous = false; // Stop after first utterance/pause
                        recognition.interimResults = false; // Might as well disable if not continuous
                        recognition.lang = 'de-DE'; // Set language to German

                        // --- Speech Recognition Event Handlers ---
                        recognition.onstart = () => {
                            console.log("Speech recognition started (continuous=false).");
                            isMicRecording = true; // Still recording initially
                            if (recordButton) {
                                recordButton.classList.add('is-recording'); // Show recording state
                                recordButton.disabled = true; // Disable button WHILE listening
                                recordButton.title = "Aufnahme läuft...";
                                const defaultIcon = recordButton.querySelector('.mic-icon.default');
                                const recordingIcon = recordButton.querySelector('.mic-icon.recording');
                                if (defaultIcon) defaultIcon.style.display = 'none';
                                if (recordingIcon) recordingIcon.style.display = 'inline';
                            }
                            if(commentError) commentError.textContent = 'Höre zu...'; // Indicate listening
                            // Disable other inputs (but NOT clear button)
                            if (feedbackRatingButtons) feedbackRatingButtons.forEach(btn => btn.disabled = true);
                            if (allGroupButtons) allGroupButtons.forEach(btn => btn.disabled = true);
                            // Leave clearCommentButton enabled
                        };

                        recognition.onresult = (event) => {
                            console.log("--- onresult event (continuous=false) ---");

                            if (event.results.length > 0) {
                                const result = event.results[event.results.length - 1];
                                const transcript = result[0].transcript.trim();
                                const isFinal = result.isFinal;
                                const confidence = result[0].confidence;

                                console.log(`Result: Final=${isFinal}, Conf=${confidence ? confidence.toFixed(3) : 'N/A'}, Text='${transcript}'`);

                                if (transcript.length > 0 && commentInput) {
                                     console.log("%cAPPENDING transcript:", "color: green; font-weight: bold;", transcript);
                                     const needsSpace = commentInput.value.length > 0 && !commentInput.value.endsWith(' ');
                                     commentInput.value += (needsSpace ? ' ' : '') + transcript; // APPEND this time
                                     commentInput.scrollTop = commentInput.scrollHeight;
                                     updateClearButtonVisibility(); // <<< Show clear button if needed
                                } else {
                                    console.log("Received empty transcript.");
                                }
                            } else {
                                console.log("No results received in this event.");
                            }
                            // Recognition stops automatically, state is reset in onend
                        };

                        recognition.onerror = (event) => {
                            console.error('Speech recognition error:', event.error, event.message);
                            let errorMessage = 'Spracherkennungsfehler.';
                            switch(event.error) {
                                case 'no-speech': errorMessage = 'Keine Sprache erkannt. Bitte erneut versuchen.'; break;
                                case 'audio-capture': errorMessage = 'Mikrofonfehler. Zugriff erlaubt?'; break;
                                case 'not-allowed': errorMessage = 'Zugriff auf Mikrofon verweigert.'; break;
                                case 'network': errorMessage = 'Netzwerkfehler bei der Spracherkennung.'; break;
                                case 'aborted': errorMessage = 'Aufnahme abgebrochen.'; break;
                                default: errorMessage = `Fehler: ${event.error}`;
                            }
                            if (event.error !== 'aborted') {
                                if(commentError) commentError.textContent = errorMessage;
                                playSound('error');
                            }
                            // `onend` handles UI reset
                        };

                        recognition.onend = () => {
                            console.log("Speech recognition ended (continuous=false).");
                            isMicRecording = false; // No longer recording
                            if (recordButton) {
                                recordButton.classList.remove('is-recording');
                                recordButton.disabled = false; // Re-enable button for next utterance
                                recordButton.title = speechApiSupported ? "Kommentar diktieren" : "Spracherkennung nicht unterstützt";
                                const defaultIcon = recordButton.querySelector('.mic-icon.default');
                                const recordingIcon = recordButton.querySelector('.mic-icon.recording');
                                if (defaultIcon) defaultIcon.style.display = 'inline';
                                if (recordingIcon) recordingIcon.style.display = 'none';
                            }
                            if (commentError && commentError.textContent.startsWith('Höre zu...')) {
                                commentError.textContent = '';
                            }
                            // Re-enable other inputs
                            if (feedbackRatingButtons) feedbackRatingButtons.forEach(btn => btn.disabled = false);
                            if (allGroupButtons) allGroupButtons.forEach(btn => btn.disabled = false);
                            // Ensure clear button state is correct based on comment (might already be visible)
                            updateClearButtonVisibility();
                        };

                    } else {
                        console.warn("Web Speech API is not supported by this browser.");
                        speechApiSupported = false;
                        if (recordButton) {
                            recordButton.disabled = true;
                            recordButton.title = "Spracherkennung nicht unterstützt";
                        }
                    }
                    // --- End Web Speech API Setup ---

                    // --- Functions Definitions ---

                    // <<< NEW: Function to control clear button visibility >>>
                    function updateClearButtonVisibility() {
                        if (!commentInput || !clearCommentButton) return; // Safety check
                        try {
                            const commentText = commentInput.value.trim();
                            if (commentText.length > 0) {
                                clearCommentButton.classList.remove('hidden');
                            } else {
                                clearCommentButton.classList.add('hidden');
                            }
                        } catch (e) {
                            console.error("Error updating clear button visibility:", e);
                            if(clearCommentButton) clearCommentButton.classList.add('hidden'); // Hide on error
                        }
                    }

                    function playSound(soundKey) {
                        console.log(`Attempting to play sound: ${soundKey}`);
                        if (sounds[soundKey]) {
                            try {
                                if (lastPlayedRatingSound && soundKey.startsWith('rating-')) {
                                    lastPlayedRatingSound.pause();
                                    lastPlayedRatingSound.currentTime = 0;
                                }
                                sounds[soundKey].currentTime = 0;
                                const playPromise = sounds[soundKey].play();
                                if (playPromise !== undefined) {
                                    playPromise.then(_ => {
                                        console.log(`Sound '${soundKey}' played successfully.`);
                                        if (soundKey.startsWith('rating-')) { lastPlayedRatingSound = sounds[soundKey]; }
                                    }).catch(error => console.error(`Audio Playback Error for '${soundKey}':`, error));
                                }
                                return sounds[soundKey];
                            } catch (e) { console.error(`Error playing sound '${soundKey}':`, e); }
                        } else { console.warn(`Sound key '${soundKey}' not found.`); }
                        return null;
                    }

                    function showScreen(screenToShow){
                        console.log(`Showing screen: ${screenToShow.id}`);
                        document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
                        screenToShow.classList.add('active');
                    }

                    function formatTimestamp(date){
                        const pad = (num) => num.toString().padStart(2, '0');
                        return `${pad(date.getDate())}.${pad(date.getMonth() + 1)}.${date.getFullYear()} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
                    }

                    function deselectAllGroups(){
                        console.log("Deselecting all groups.");
                        selectedGroup = null;
                        if (feedbackScreen) feedbackScreen.classList.remove('group-selected');
                        if (allGroupButtons) allGroupButtons.forEach(btn => btn.classList.remove('selected'));
                        console.log(`Selected group after deselect: ${selectedGroup}`);
                    }

                    function resetApp() {
                        console.log("--- Resetting App ---");
                        if (isMicRecording && recognition) {
                            console.log("Stopping speech recognition during reset (precautionary).");
                             try { recognition.abort(); } catch (e) { console.warn("Error aborting recognition during reset:", e); }
                        }
                        isSubmitting = false;
                        selectedRating = null;
                        deselectAllGroups();
                        if (commentInput) commentInput.value = '';
                        if (commentError) commentError.textContent = '';
                        if (loadingIndicator) loadingIndicator.style.display = 'none';
                        if (feedbackRatingButtons) feedbackRatingButtons.forEach(btn => btn.disabled = false);
                        if (allGroupButtons) allGroupButtons.forEach(btn => btn.disabled = false);
                        if (feedbackScreen && thankYouScreen) showScreen(feedbackScreen);

                        // Reset Mic button state
                        isMicRecording = false; // Ensure state is reset
                        if (recordButton) {
                            recordButton.classList.remove('is-recording');
                            recordButton.disabled = !speechApiSupported;
                            recordButton.title = speechApiSupported ? "Kommentar diktieren" : "Spracherkennung nicht unterstützt";
                            const defaultIcon = recordButton.querySelector('.mic-icon.default');
                            const recordingIcon = recordButton.querySelector('.mic-icon.recording');
                            if (defaultIcon) defaultIcon.style.display = 'inline';
                            if (recordingIcon) recordingIcon.style.display = 'none';
                        }

                        // <<< Reset Clear Button state >>>
                         updateClearButtonVisibility();
                         if (clearCommentButton) clearCommentButton.disabled = false; // Ensure enabled

                        lastPlayedRatingSound = null;
                        console.log("--- App Reset Complete ---");
                    }

                    async function submitFeedback() {
                        console.log("%c--- SUBMITTING FEEDBACK ---", "color: blue; font-weight: bold;");
                        console.log(`Group: ${selectedGroup}, Rating: ${selectedRating}, Comment: '${commentInput ? commentInput.value.trim() : 'N/A'}'`);

                        if (!selectedGroup || !selectedRating) {
                            console.error("Submit cancelled: Group or Rating missing.");
                            if(commentError) commentError.textContent = 'Fehler: Gruppe oder Bewertung fehlt.';
                            playSound('error'); return;
                        }
                        if (isSubmitting) { console.warn("Submit cancelled: Already submitting."); return; }
                        if (isMicRecording) { console.warn("Submit cancelled: Mic seems active (should have stopped)."); if(commentError) commentError.textContent = 'Bitte warten bis Aufnahme endet.'; playSound('error'); return; }

                        const currentComment = commentInput ? commentInput.value.trim() : '';
                        if (selectedRating === "3" && currentComment.length < commentRequiredLength) {
                            console.error("Submit cancelled: Comment too short for negative rating.");
                            if(commentError) commentError.textContent = `Negatives Feedback braucht einen Kommentar (mind. ${commentRequiredLength} Zeichen).`;
                            if(commentInput) commentInput.focus(); playSound('error'); return;
                        }

                        isSubmitting = true;
                        if(loadingIndicator) loadingIndicator.style.display = 'block';
                        if(feedbackRatingButtons) feedbackRatingButtons.forEach(btn => btn.disabled = true);
                        if(allGroupButtons) allGroupButtons.forEach(btn => btn.disabled = true);
                        if(recordButton) recordButton.disabled = true;
                        if(clearCommentButton) clearCommentButton.disabled = true; // <<< Disable clear button during submit

                        const timestamp = formatTimestamp(new Date());
                        const dataToSend = { timestamp: timestamp, gruppe: selectedGroup, bewertung: selectedRating, kommentar: currentComment };
                        console.log("Data to send:", dataToSend);

                        try {
                            console.log(`Sending POST request to: ${googleAppsScriptUrl}`);
                             await fetch(googleAppsScriptUrl, {
                                 method: 'POST',
                                 mode: 'no-cors',
                                 cache: 'no-cache',
                                 headers: { 'Content-Type': 'application/json' },
                                 body: JSON.stringify(dataToSend)
                             });

                            console.log("Fetch call completed (no-cors, assumed success).");
                            if (lastPlayedRatingSound) { lastPlayedRatingSound.pause(); lastPlayedRatingSound.currentTime = 0; lastPlayedRatingSound = null; }
                            playSound('sent');
                            showScreen(thankYouScreen);
                            // resetApp is called via timeout below
                            setTimeout(resetApp, thankYouDuration);
                        } catch (error) {
                            console.error("Submission Error:", error);
                            if(loadingIndicator) loadingIndicator.style.display = 'none';
                            if(commentError) commentError.textContent = 'Fehler beim Senden. Bitte versuche es erneut.';
                            playSound('error');
                            // Re-enable buttons on error
                            if(feedbackRatingButtons) feedbackRatingButtons.forEach(btn => btn.disabled = false);
                            if(allGroupButtons) allGroupButtons.forEach(btn => btn.disabled = false);
                            if (recordButton) recordButton.disabled = !speechApiSupported;
                            if (clearCommentButton) clearCommentButton.disabled = false; // <<< Re-enable clear button on error
                            updateClearButtonVisibility(); // Ensure visibility is correct
                            isSubmitting = false;
                        }
                    }

                    // --- EVENT LISTENER ATTACHMENT ---
                    console.log("Attaching event listeners...");
                    try {
                        // Group Buttons Listener
                        if (allGroupButtons && allGroupButtons.length > 0) {
                            allGroupButtons.forEach((button, index) => {
                                const groupName = button.dataset.group; if (!button || !groupName) { console.warn(`Skipping group button at index ${index}`); return; }
                                button.addEventListener('click', (event) => {
                                    console.log(`%cGROUP CLICK: '${groupName}'`, "background: orange; color: black;");
                                    // Disallow clicks if recording (even though it should stop fast)
                                    if (isSubmitting || isMicRecording) { console.log(`Group click ignored: submitting=${isSubmitting}, recording=${isMicRecording}`); return; }
                                    const clickedButton = event.currentTarget; const group = groupName; const wasSelected = clickedButton.classList.contains('selected');
                                    if (wasSelected) { deselectAllGroups(); } else {
                                        deselectAllGroups(); selectedGroup = group;
                                        if (group === '1-4 Klasse' || group === '5-8 Klasse' || group === '9-12 Klasse') { if (sounds[group]) playSound(group); }
                                        if(feedbackScreen) feedbackScreen.classList.add('group-selected'); clickedButton.classList.add('selected');
                                    }
                                    console.log(`Selected group: ${selectedGroup}`); if(commentError) commentError.textContent = '';
                                });
                            });
                            console.log("Attached Group Listeners.");
                        } else { console.error("Group listener attachment skipped - no buttons."); }

                        // Rating Buttons Listener
                        if (feedbackRatingButtons && feedbackRatingButtons.length > 0) {
                            feedbackRatingButtons.forEach((button) => {
                                const ratingValue = button.dataset.rating; if (!button || !ratingValue) { console.warn("Skipping rating button"); return; }
                                button.addEventListener('click', (event) => {
                                    console.log(`RATING CLICK: '${ratingValue}'`);
                                    if(commentError) commentError.textContent = '';
                                    // Disallow clicks if recording
                                    if (isSubmitting || isMicRecording) { console.log(`Rating click ignored: submitting=${isSubmitting}, recording=${isMicRecording}`); return; }
                                    if (!selectedGroup) { console.warn("Rating click ignored: No group selected."); if (commentError) commentError.textContent = 'Wähle zuerst deine Klasse/Gruppe'; playSound('error'); return; }

                                    selectedRating = ratingValue;
                                    console.log('Selected rating:', selectedRating);

                                    const currentComment = commentInput ? commentInput.value.trim() : '';
                                    if (selectedRating === "3" && currentComment.length < commentRequiredLength) {
                                        console.warn("Submit blocked: Comment required for negative rating.");
                                        if (commentError) commentError.textContent = `Negatives Feedback braucht einen Kommentar (mind. ${commentRequiredLength} Zeichen).`;
                                        if (commentInput) commentInput.focus(); playSound('error');
                                        selectedRating = null;
                                        return;
                                    }
                                    let soundKey = `rating-${selectedRating}`;
                                    if (selectedRating === "3") { soundKey = 'rating-3-success'; }
                                    console.log(`SOUND: Rating ${selectedRating} -> Key '${soundKey}'`);
                                    if (lastPlayedRatingSound) { lastPlayedRatingSound.pause(); lastPlayedRatingSound.currentTime = 0; lastPlayedRatingSound = null; }
                                    lastPlayedRatingSound = playSound(soundKey);
                                    submitFeedback();
                                });
                            });
                            console.log("Attached Rating Listeners.");
                        } else { console.error("Rating listener attachment skipped - no buttons."); }

                        // Microphone Button Listener
                        if (recordButton && speechApiSupported) {
                            recordButton.addEventListener('click', () => {
                                console.log("MIC CLICK (continuous=false)");
                                if (!recognition) { console.error("Recognition not initialized!"); return; }
                                if (isSubmitting) { console.log("Mic ignored: Submitting"); return; }
                                console.log("Calling recognition.start()");
                                try {
                                    // Don't clear comment box automatically, user might want to add multiple phrases
                                    if(commentError) commentError.textContent = '';
                                    recognition.start();
                                } catch (e) {
                                    console.error("Error calling recognition.start():", e);
                                    if(commentError) commentError.textContent = "Fehler beim Starten der Aufnahme.";
                                    isMicRecording = false;
                                    if (recordButton) {
                                        recordButton.classList.remove('is-recording');
                                        recordButton.disabled = !speechApiSupported;
                                        recordButton.title = speechApiSupported ? "Kommentar diktieren" : "Spracherkennung nicht unterstützt";
                                        const defaultIcon = recordButton.querySelector('.mic-icon.default');
                                        const recordingIcon = recordButton.querySelector('.mic-icon.recording');
                                        if (defaultIcon) defaultIcon.style.display = 'inline';
                                        if (recordingIcon) recordingIcon.style.display = 'none';
                                    }
                                }
                            });
                            console.log("Attached Mic Listener for Web Speech API (continuous=false).");
                        } else if (recordButton) {
                            console.log("Mic listener skipped - API not supported or button error.");
                            recordButton.disabled = true;
                            recordButton.title = "Spracherkennung nicht unterstützt";
                        } else { console.error("Mic listener skipped - button not found."); }

                        // <<< NEW: Clear Comment Button Listener >>>
                        if (clearCommentButton) {
                            clearCommentButton.addEventListener('click', () => {
                                console.log("CLEAR COMMENT CLICK");
                                if (commentInput) {
                                    commentInput.value = ''; // Clear the text area
                                }
                                // Attempt to stop recording if active (using abort for immediate effect)
                                if (isMicRecording && recognition) {
                                    console.log("Aborting speech recognition due to clear click.");
                                    try {
                                        recognition.abort();
                                        // Note: onend will likely fire after abort, handling UI reset
                                    } catch (e) {
                                        console.warn("Error aborting recognition on clear:", e);
                                        // Manually ensure state is reset if abort fails
                                        isMicRecording = false;
                                        // Manually reset mic button UI just in case onend doesn't fire
                                        if (recordButton) {
                                            recordButton.classList.remove('is-recording');
                                            recordButton.disabled = !speechApiSupported;
                                            recordButton.title = speechApiSupported ? "Kommentar diktieren" : "Spracherkennung nicht unterstützt";
                                            const defaultIcon = recordButton.querySelector('.mic-icon.default');
                                            const recordingIcon = recordButton.querySelector('.mic-icon.recording');
                                            if (defaultIcon) defaultIcon.style.display = 'inline';
                                            if (recordingIcon) recordingIcon.style.display = 'none';
                                            // Re-enable other buttons if necessary
                                            if (feedbackRatingButtons) feedbackRatingButtons.forEach(btn => btn.disabled = false);
                                            if (allGroupButtons) allGroupButtons.forEach(btn => btn.disabled = false);
                                        }
                                    }
                                }
                                if(commentError) commentError.textContent = ''; // Clear any error message
                                updateClearButtonVisibility(); // Hide the clear button itself
                            });
                            console.log("Attached Clear Comment Listener.");
                        }

                        // <<< NEW: Listener for manual input in comment box >>>
                         if (commentInput) {
                            commentInput.addEventListener('input', updateClearButtonVisibility);
                            console.log("Attached input listener to comment box.");
                         }

                    } catch (listenerError) {
                        console.error("Error during event listener attachment:", listenerError);
                        if(commentError) commentError.textContent = "App-Fehler: Listener konnten nicht initialisiert werden.";
                    }
                    // --- End Listener Attachment ---

                    // --- Initial Setup ---
                    console.log("Running Initial Setup...");
                    resetApp(); // Call reset first (which now includes updateClearButtonVisibility)
                    if (thankYouScreen) thankYouScreen.classList.remove('active');
                    if (feedbackScreen) feedbackScreen.classList.add('active');
                    // updateClearButtonVisibility(); // Called inside resetApp now
                    console.log(`Initial State after setup: selectedGroup=${selectedGroup}, selectedRating=${selectedRating}, isSubmitting=${isSubmitting}, speechApiSupported=${speechApiSupported}`);
                    console.log("--- App Initialized Successfully ---");

                } catch (initError) {
                    console.error("Error during DOMContentLoaded initialization:", initError);
                    const errElement = document.getElementById('comment-error'); const mainContent = document.getElementById('feedback-main-content');
                    if (errElement) { errElement.textContent = "Schwerwiegender App-Fehler beim Initialisieren. Bitte neu laden."; errElement.style.display = 'block'; }
                    else { alert("Schwerwiegender App-Fehler beim Initialisieren. Bitte laden Sie die Seite neu."); }
                    if (mainContent) mainContent.style.display = 'none';
                }
            }); // End DOMContentLoaded listener
        } catch (globalError) {
            console.error("GLOBAL JavaScript Error (likely Syntax Error):", globalError);
            try { document.body.innerHTML = `<div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; justify-content: center; align-items: center; padding: 20px; text-align: center; color: red; font-size: 1.2em; font-family: sans-serif; z-index: 9999;">Ein schwerwiegender JavaScript-Fehler ist aufgetreten.<br>Die App kann nicht starten.<br>Prüfen Sie die Browser-Konsole (F12) für Details.</div>`; }
            catch (e) { alert("Ein schwerwiegender JavaScript-Fehler ist aufgetreten. Die App kann nicht starten. Prüfen Sie die Browser-Konsole."); }
        }
        console.log("--- script.js finished parsing (sync part) ---");
        // --- END OF updated script.js content ---
    </script>

</body>
</html>
